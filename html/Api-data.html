<!DOCTYPE html>
<html lang="en">
<head>
  <title>External Api</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  
  
<style>
body {
  background-color: #383838;
}
</style>
</head>

<body>

  
  <div class="container-fluid  h-100 bg-dark">


    <!-- Fila Main-->
    
    <div class="row 12">
      <!-- Columna Data Get-->
      <div class="col-4 m-2">
          <!-- Card-->
            <div class="card " style="width:370px">
              <!-- Fila Setting Auto Get-->
                <div class="row 12">
                  <!-- Columna (1) Setting Auto Get-->
                  <div class="col-1 float-right ">
                    <img src="Setting_Icon.png" class="img-circle" data-toggle="modal" data-target="#myModal" onclick="UserData();" alt="Girl in a jacket" width="30" height="30">
                    </div>
                  <!-- Columna (2) SDeescription-->
                  <div class="col-7 float-right text-center">
                    
                    
                  </div>
                  <!-- Columna (3 ) Check-->
                  <div class="col-4 float-right ">
                    
                    Sign Out &nbsp<a href="#" id="close" ><img src="salir.png" class="img-circle"   width="30" height="30"></a>
                    
                  
                  </div>
                  <!-- Columna Data Main-->
                </div>
              <!-- Get Auto Data-->
              <div class="text-center">
                <span class="font-weight-bold p-b-1 text-center">Auto-Get <input type="checkbox" name="acceptRules" class="inline checkbox" id="checkbox1" value="false"></span>
              </div>
              <!-- Picture Data-->
              <div id= Picture class="text-center">
                <img class="card-img-top" src="Robot.png" alt="Card image" style="width:70% height=70%">
              </div>
              
              <!-- Data Person body-->
                
                  <!-- Name and Match-->
                  <div id= IdentityName class="text-center small">
                    <h5 class="card-title text-center"><strong>Name</strong></h5>
                  </div>
                  <div class="card-body">
                  <!-- Lista de Datos-->
                  <div class="list-group">
                    
                    <a href="#" class="list-group-item list-group-item-action small"><div id="FaceId">FaceId:</div> </a>
                    <a href="#" class="list-group-item list-group-item-action small"><div id="Age">Age:</div> </a>
                    <a href="#" class="list-group-item list-group-item-action small"><div id="Gender">Gender:</div></a>
                    <a href="#" class="list-group-item list-group-item-action small"><div id="Emotion1">Emotion:</div></a>
                    <a href="#" class="list-group-item list-group-item-action small"><div id="IsEngaged">Engaged:</div></a>
                    <a href="#" class="list-group-item list-group-item-action small"><div id="IdService">Service:</div></a>
                    <a href="#" class="list-group-item list-group-item-action small"><div id="FrameTime">FrameTime:</div></a>
                    <a href="#" class="list-group-item list-group-item-action small"><div id="CameraName">Camera:</div></a>
                   <!--  <a href="#" class="list-group-item list-group-item-action small"><div id="CameraDescription">Description:</div></a> -->
                  </div>
                </div>
              <!-- Boton Get -->
                
                <button  class="btn btn-primary" onclick="GetData(); ListData ();">Get Data</button>
                
                
            </div> 
      </div> 
      <!-- Columna Data List-->
      <div class="col-7">
        <div class="row 12">
          <!-- Columna Data Get-->
          <div class="col-3 m-2">
            <button  class="btn btn-warning btn-sm float-letf" onclick="Token();">Token</button>
          </div>
          <div class="col-4 m-2 text-info">
            <h6 id="userbox"></h6>
          </div>
          <div class="col-4 m-2">
            <button  class="btn btn-danger float-right" onclick="DeleteAllData();">Delete All Data</button>
          </div>
        </div>
        <!-- Tabla -->
          <table class="table table-dark table-hover text-center">
            <!-- Head Table-->
            <thead >
              <tr>
            <th>Picture</th>
                <th>Name</th>
                <th>Match</th>
            <th>Age</th>
                <th>Gender</th>
            <th>FrameTime</th>
            <th>Delete</th>
              </tr>
            </thead>
            <!-- Body table -->
            <tbody  id="DataList">
              
            </tbody>
          </table>
      </div>
        
    </div>
    
    <br>
  </div>

 <!-- The Modal -->
  <div class="modal" id="myModal">
    <div class="modal-dialog">
      <div class="modal-content">
      
        
        <!-- Modal Header -->
        
        
        <!-- Modal body -->
        <div class="modal-body">
          <div id="Alerta">
      
          </div>
          <!-- <form name="formulario" action="http://192.168.100.233:5080/Update/3" method="POST" >-->
            <form id="formulario" >
              <h5 class=" text-center">Setting </h5>
              <div id="FormSetting"></div>
            
          </form>
        </div>
        
      </div>
    </div>
  </div>


</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="js/nav.js"></script>


<script>
// ********************************************************************
// Funcion para Auto Get
// ********************************************************************
// cada Vez que se un cambio de estado al Checkbox Auto-get se captura el cambio
// Cuando esta en true se realiza peticiones cada (x) Intervalo de Tiempo
$('#checkbox-value').text($('#checkbox1').val());
var AutoGet = $('#checkbox1').val();
console.log("- AutoGet: " + AutoGet);

$("#checkbox1").on('change', function() {
  if ($(this).is(':checked')) {
    $(this).attr('value', 'true');

  } else {
    $(this).attr('value', 'false');

  }
  // Capturamos el estado de la variable Auto-get
  var AutoGet = $('#checkbox1').val();
  
  // Si el Checkbox es true ejecutamos el intervalo, (mismo que llama a la Funcion GetData)
  if (AutoGet ==="true"){
    console.log("- Auto-Get is: " + AutoGet);
    intervalo = setInterval (() => { GetData(AutoGet); ListData ();}, 10000);

  // Si el Checkbox es false detenemos el intervalo mediante ClearInterval
  } else{
    console.log("- Auto-Get is: " + AutoGet);
    clearInterval(intervalo);
  }

});
</script>

<script>
// ********************************************************************
// Get data (LiveEndpoint)
// ********************************************************************
function GetData(i) {
 
	// IMPORTANT
	// You must indicate the url that sends the data (Token and data)
      
  console.log("AutoGet:" + i)
  var formData = new FormData();
  let username = JSON.parse(localStorage.getItem('User'));
  formData.append('Email', username);

  fetch('http://192.168.100.51:5080/LiveEndpointData', {
    method: 'POST',
    body: formData
    })
    .then(Datos=>Datos.json())
  .then(Datos=>{
    ImageURL = Datos.CapturedImageURL
    console.log(ImageURL)
    Name = Datos.EndpointData['Confidence']
    console.log(Name)
		// Frame
    
      Picture.innerHTML = '';
        Picture.innerHTML += `
        <img src="data:image/png;base64, ${Datos.CapturedImageURL}" width="45%" height="45%" alt="base64 test">
        
		`;
    // IdentityName
      
      IdentityName.innerHTML = '';
          IdentityName.innerHTML += `
       <strong>Name - (%)</strong>
      `;
    
		// FaceId
        FaceId.innerHTML = '';
        FaceId.innerHTML += `
			<strong>FaceId: </strong>${Datos.EndpointData['FaceId']}
		`;
    // Age
    Age.innerHTML = '';
        Age.innerHTML += `
			<strong>Age: </strong>${Datos.EndpointData['Age']}
		`;

    // Gender
      Gender.innerHTML = '';
      Gender.innerHTML += `
			<strong>Gender: </strong>${Datos.EndpointData['Gender']}
		`;

      // IsEngaged
      IsEngaged.innerHTML = '';
      IsEngaged.innerHTML += `
			<strong>Engaged: </strong>${Datos.EndpointData['IsEngaged']}
		`;

    // IdService
    if (Datos.EndpointData['IdService'] === 1){
        var Service = "Edge";
      } else {
        var Service = "Cloud";
      }
      IdService.innerHTML = '';
      IdService.innerHTML += `
			<strong>Service: </strong>${Service}
		`;
    // FrameTime
      FrameTime.innerHTML = '';
      FrameTime.innerHTML += `
			<strong>Frame Time: </strong>${Datos.EndpointData['FrameTime']}
		`;
		// CameraName
        CameraName.innerHTML = '';
        CameraName.innerHTML += `
			<strong>Camera Name: </strong>${Datos.EndpointData['CameraName']}
		`;
		// CameraDescription
        //CameraDescription.innerHTML = '';
       // CameraDescription.innerHTML += `
			//<strong>Camera Description: </strong>${Datos.EndpointData['CameraDescription']}
		//`;

    // Emotios  
    var Anger = Datos.EndpointData['Emotions']['Anger'];
    var Contempt = Datos.EndpointData['Emotions']['Contempt'];
    var Disgust = Datos.EndpointData['Emotions']['Disgust'];
    var Fear = Datos.EndpointData['Emotions']['Fear'];
    var Happiness = Datos.EndpointData['Emotions']['Happiness'];
    var Neutral = Datos.EndpointData['Emotions']['Neutral'];
    var Sadness = Datos.EndpointData['Emotions']['Sadness'];
    var Surprise = Datos.EndpointData['Emotions']['Surprise'];

    var Emotions = [Anger, Happiness, Neutral, Sadness, Surprise];

    if (Contempt != null) {
      Emotions.push(Contempt);
    } 
    if (Disgust != null) {
      Emotions.push(Disgust);
    }
    if (Fear != null) {
      Emotions.push(Fear);
    }  
        
    var EmotionsList = Emotions.sort();
    var LenEmotins = Emotions.length - 1;
    var Emotion = EmotionsList[LenEmotins];


        var json = Datos.EndpointData['Emotions']
        for (var clave in json){
          // Controlando que json realmente tenga esa propiedad
          if (json.hasOwnProperty(clave)) {
            // Mostrando en pantalla la clave junto a su valor
            if ( json[clave] === Emotion){
              var EmotionShow =  clave+ ": " + json[clave];
            }
            //alert("La clave es " + clave+ " y el valor es " + json[clave]);
          }
        }
        
        //console.log(EmotionShow);
        //console.log(EmotionsList);
        
        Emotion1.innerHTML = '';
        Emotion1.innerHTML += `
			<strong>Emotion: </strong>${EmotionShow}
		`;
		
		
			})


}
</script>

<script>
// ********************************************************************
// Get List Data (All Record)
// ********************************************************************
function ListData (){
  var formData = new FormData();
  let username = JSON.parse(localStorage.getItem('User'));
  formData.append('Email', username);

  fetch('http://192.168.100.51:5080/Data', {
    method: 'POST',
    body: formData
    })

  .then(ListTest=>ListTest.json())
  .then(ListTest=>{
    
      
      var Message = ListTest[0].Message
      console.log(ListTest)
      console.log(Message)   
      var n = 0;
      DataList.innerHTML = '';
      if (Message !== undefined){
        console.log('Lista Vacia')
      
      }
        else{
          for(let dato of ListTest){
                    
                    // console.log(dato.Gender)
                     DataList.innerHTML += `
                     <tr>
                       
                           <td><img src="data:image/png;base64, ${dato.Image}" width="50" height="50" ></td>
                           <td>${dato.Name}</td>
                           <td>${dato.Match}%</td>
                           <td>${dato.Age}</td>
                           <td>${dato.Gender}</td>
                           <td>${dato.FrameTime}</td>
                           <td><a  href="#" ><img src="Delete_Icon.png"  data-target="#myModal" width="15" height="15"></td></a>
                           
                         </tr>
                     `
                     n++;
                   }
        }})} 
</script>

<script>
// ********************************************************************
// Delete All Records
// ********************************************************************
function DeleteAllData (){
 
  var formData = new FormData();
  let username = JSON.parse(localStorage.getItem('User'));
  formData.append('Email', username);
  formData.append('Parametro', 'all');

  fetch('http://192.168.100.51:5080/Data', {
    method: 'DELETE',
    body: formData
    })

  .then(ListTest=>ListTest.json())
  .then(ListTest=>{
    
    console.log('Delete all Record')
   
    DataList.innerHTML = '';
  }
  
  )}
</script>

<script>
  // ********************************************************************
  // Delete All Records
  // ********************************************************************
  function deleteOne (file){
   
    var formData = new FormData();
    let username = JSON.parse(localStorage.getItem('User'));
    formData.append('Email', username);
    formData.append('Parametro', file);
    console.log(file)
    fetch('http://192.168.100.51:5080/Data', {
      method: 'DELETE',
      body: formData
      })
  
    .then(ListTest=>ListTest.json())
    .then(ListTest=>{
      
      console.log('Delete One Record - ' + file)
     
      DataList.innerHTML = '';
    }
    
    )}
  </script>


<script>
function Token(){
  var formData = new FormData();
  let username = JSON.parse(localStorage.getItem('User'));
  formData.append('Email', username);

  fetch('http://192.168.100.51:5080/Token', {
      method: 'PUT',
      body: formData
      })

.then(res => res.json()) // or res.json()
.then(res => {
console.log(res)
let TokenError = res.Error

if (TokenError === "unsupported_grant_type" || TokenError === "invalid_client"){
   {alert("¡Error intentado Generar el Token! \n  Type: " + res.Error + "\n - " + res.Mensaje )}
}else{
  {alert("¡Token Generado! \n - " + res[0].Generated + "\n - " + res[0].Environment  + "\n - Token Expira en Una Hora" )}
}

})



  }
</script>

<script>
  // ********************************************************************
  // Get User data
  // ********************************************************************
  function UserData (){
    var formData = new FormData();
    let username = JSON.parse(localStorage.getItem('User'));
    formData.append('Email', username);
  
    fetch('http://192.168.100.51:5080/User/' + username)
  
    .then(ListTest=>ListTest.json())
    .then(ListTest=>{
      console.log(username)
      console.log(ListTest)

        var n = 0;
        FormSetting.innerHTML = '';
        
            for(let dato of ListTest){
              IntervaloUser = dato.Intervalo
              EnvironmentUser = dato.Environment
              NotificationEmail = dato.Notification
                      // console.log(dato.Gender)
                      FormSetting.innerHTML += `
                      <div class="form-group">
              <label for="GrantType">Grant Type:</label>
              <input type="text" class="form-control" id="GrantType" placeholder="Enter username" name="GrantType"  value=" ${dato.GrantType}">

            </div>
            <div class="form-group">
              <label for="ClientId">Client Id:</label>
              <input type="text" class="form-control" id="ClientId" placeholder="Enter ClientId" name="ClientId" value=" ${dato.APIKey}">

            </div>
            <div class="form-group">
              <label for="ClientSecret">Client Secret:</label>
              <input type="text" class="form-control" id="ClientSecret" placeholder="Enter ClientSecret" name="ClientSecret" value=" ${dato.APISecret}">

            </div>
            <div class="form-group">
              <label for="EndpointId">Endpoint Id:</label>
              <input type="text" class="form-control" id="EndpointId" placeholder="Enter EndpointId" name="EndpointId" value=" ${dato.EndpointId}">

            </div>
            
            <div class="form-group">
              <label for="Intervalo" id="">Intervalo Auto-Get:</label>
              <div id="IntervaloS"></div>
              
                
              
            </div>
            <div class="form-group">
              <div id="EnvironmentOP"></div>
              
            </div>
            <div class="form-group">
              <label for="Intervalo" id="">Email Notifications</label>
              <div id="NotificationE"></div>
            </div>
        </div>
        
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Submit</button>
                       `
                       
                       n++;
                     
                       
                    if (IntervaloUser === 1) {
                      IntervaloS.innerHTML += `
                      <select class="form-control"  name="Intervalo">
                      <option value="1" selected>1 Segundos</option>
                      <option value="10">10 Segundos</option>
                      <option value="30">30 Segundos</option>
                      <option value="60">60 Segundos</option>
                    </select>
                      `
                    } else if (IntervaloUser === 10) {
                      IntervaloS.innerHTML += `
                      <select class="form-control"  name="Intervalo">
                      <option value="1">1 Segundos</option>
                      <option value="10" selected>10 Segundos</option>
                      <option value="30" >30 Segundos</option>
                      <option value="60">60 Segundos</option>
                    </select>
                      `
                    }else if (IntervaloUser === 30) {
                      IntervaloS.innerHTML += `
                      <select class="form-control"  name="Intervalo">
                      <option value="1">1 Segundos</option>
                      <option value="10">10 Segundos</option>
                      <option value="30" selected>30 Segundos</option>
                      <option value="60">60 Segundos</option>
                    </select>
                      `
                    } else {
                      IntervaloS.innerHTML += `
                      <select class="form-control"  name="Intervalo">
                      <option value="1">1 Segundos</option>
                      <option value="10">10 Segundos</option>
                      <option value="30">30 Segundos</option>
                      <option value="60" selected>60 Segundos</option>
                    </select>
                      `
                    }
                    // enviroment
                    if (EnvironmentUser === "https://apivnext.vsblty.net/"){
                      EnvironmentOP.innerHTML += `
                      <div class="form-check-inline">
                
                <label class="form-check-label">
                  <input type="radio"  value="1" class="form-check-input" name="Environment" checked>Prodution
                </label>
              </div>
              <div class="form-check-inline">
                <label class="form-check-label">
                  <input type="radio"  value="0" class="form-check-input" name="Environment" >Test
                </label>
              </div>
                      `
                    }else{
                      EnvironmentOP.innerHTML += `
                      <div class="form-check-inline">
                
                <label class="form-check-label">
                  <input type="radio"  value="1" class="form-check-input" name="Environment" >Prodution
                </label>
              </div>
              <div class="form-check-inline">
                <label class="form-check-label">
                  <input type="radio"  value="0" class="form-check-input" name="Environment" checked>Test
                </label>
              </div>
                      `
                    }
                    // Notificaion EMail
                    if (NotificationEmail === 1){
                      NotificationE.innerHTML += `
                      <select class="form-control"  name="Notification">
                <option value="1" selected>Enabled</option>
                <option value="0">Disabled</option>
              </select>
              `
                    }else{
                      NotificationE.innerHTML += `
                      <select class="form-control"  name="Notification">
                <option value="1" >Enabled</option>
                <option value="0" selected>Disabled</option>
              </select>
              `
                    }
                    }
          })} 
  </script>

<script>
  // Get the modal
  var modal = document.getElementById('id01');
  
  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
</script>

<!-- Funcion para llamar la funcion Getdata al inciar la pagina-->
<script>
  window.onload=GetData("window.onload");
  window.onload=ListData("window.onload");
</script>

<script>
// Formulario para actualizar la data del User
  var formulario = document.getElementById('formulario');
  
  formulario.addEventListener('submit', function(e){
    e.preventDefault();
  
    var datos = new FormData(formulario);
    var formData = new FormData();
    let username = JSON.parse(localStorage.getItem('User'));
    // data send
    formData.append('Email', username);
    formData.append('GrantType', datos.get('GrantType'));
    formData.append('ClientId', datos.get('ClientId'));
    formData.append('ClientSecret', datos.get('ClientSecret'));
    formData.append('EndpointId', datos.get('EndpointId'));
    formData.append('Environment', datos.get('Environment'));
    formData.append('Intervalo', datos.get('Intervalo'));
    formData.append('Notification', datos.get('Notification'));

    //console.log(datos.get('GrantType'))
    console.log(datos.get('Notification'))

    fetch ('http://192.168.100.51:5080/User',{
      method: 'PUT',
      body: formData
    })
      .then(res => res.json())
      .then( data=> {
        console.log(data)
        
         //{alert("¡Mensaje! " + data)}
         Alerta.innerHTML = '';
         Alerta.innerHTML += `
         <div class="alert alert-success alert-dismissible fade show">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          <strong>Success!</strong> ${data.Message}.
        </div>
          
        `;
      })
      
  })
  </script>
</html>
